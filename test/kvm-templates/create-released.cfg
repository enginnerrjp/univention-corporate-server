[Global]
#logfile: kvm-template.log
recover: 2

kvm_server: [ENV:KVM_BUILD_SERVER]
kvm_user: [ENV:KVM_USER]
kvm_dhcp: 1
kvm_interface: eth0
kvm_extra_label: kvm-template
kvm_template: [ENV:KVM_TEMPLATE]
kvm_ucsversion: [ENV:KVM_UCSVERSION]
kvm_architecture: amd64

[master]
command1:
 . utils.sh && add_tech_key_authorized_keys

 # Update
 ucr set repository/online=yes repository/online/server=http://updates.knut.univention.de/ updater/identify='UCS (KVM)'
 . utils.sh && upgrade_to_latest_patchlevel

 # Appliance
 . base_appliance.sh && setup_appliance
 . base_appliance.sh && appliance_cleanup

 # . base_appliance.sh && appliance_reset_servers "[ENV:RESET]"
 ucr set repository/online/server=http://updates.knut.univention.de/ update/secure_apt=yes nameserver1=192.168.0.124 nameserver2=192.168.0.97 timeserver='192.168.0.240 burst'
 usermod -p $(mkpasswd -H sha-512 univention) root

 echo 'ucsver=@%@version/version@%@-@%@version/patchlevel@%@+e@%@version/erratalevel@%@'|ucr filter>/tmp/ucs.ver
 #LOCAL scp -i ~/ec2/keys/tech.pem -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no root@[master_IP]:"/tmp/ucs.ver" .
 GET /tmp/ucs.ver ucs.ver

 . base_appliance.sh && appliance_poweroff
 SSH_DISCONNECT
 SERVER virsh event --domain "[master_KVM_NAME]" --event lifecycle --timeout 120

 # create images
 #LOCAL ssh -l "[ENV:KVM_USER]" "[ENV:KVM_BUILD_SERVER]" /home/phahn/REPOS/ucs-kvm-testenv/src/ucs-kt-put -C single -O Others -c "[master_KVM_NAME]" "$(cat ucs.ver)_generic-unsafe_amd64"
 SOURCE ucs.ver
 SERVER /home/phahn/REPOS/ucs-kvm-testenv/src/ucs-kt-put -C single -O Others -c "[master_KVM_NAME]" "[ucsver]_generic-unsafe_amd64"
command2:
 LOCAL rm -f ucs.ver

# KVM_BUILD_SERVER=lattjo KVM_USER=phahn KVM_TEMPLATE=generic KVM_UCSVERSION=4.4-6 ~/REPOS/ucs-ec2-tools/ucs-kvm-create --replace --terminate-on-success kvm-templates/create-released.cfg
